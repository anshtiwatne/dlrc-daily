<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Publish an Article</title>
    <link rel="icon" type="image/x-icon" href="./assets/logos/favicon.ico">
    <link rel="stylesheet" href="https://cdn.simplecss.org/simple.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/9.23.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/9.23.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/9.23.0/firebase-storage-compat.js"></script>
    <!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>
</head>

<style>
    body {
        font-family: 'Poppins', sans-serif;
    }
    
    input {
        width: 100%;
    }

    h3 {
        margin-top: 2rem;
    }

    input[type="file"] {
        border: 1px solid var(--border);
    }
</style>

<body>
    <header style="padding: 0;">
        <h3>Publish to DLRC Daily</h3>
    </header>

    <form id="publishForm" onsubmit="return false">
        <br>
        <label for="author">Author</label>
        <input id="author" type="text" required>

        <label for="headline">Headline</label>
        <input id="headline" type="text" placeholder="< 30 characters" maxlength="30" required>

        <label for="coverImage">Cover Image</label>
        <input id="coverImage" type="file" accept="image/webp" required>

        <label for="story">Story</label>
        <textarea id="story" type="text" placeholder="< 300 characters" maxlength="300" required></textarea>

        <label for="tag">Tag</label>
        <input id="tag" type="text" required>

        <div style="display: flex; align-items: center; text-align: center; margin-top: 2rem;">
            <input id="psswd" type="password" placeholder="Password" required>
            <button type="submit" id="publishButton" style="margin-left: 1rem; margin-bottom: 1rem;">Publish</button>
        </div><br>
    </form>
</body>

<script type="module">
    const db = firebase.firestore()
    const storage = firebase.storage()
    const colorThief = new ColorThief()
    
    function isTextLight(color) {
        // per ITU-R BT.709
        for (const i in color) {
            let component = color[i] / 255

            if (component <= 0.04045) {
                component = component / 12.92
            }
            else {
                component = ((component + 0.055) / 1.055) ** 2.4
            }

            color[i] = component
        }
        
        const L = 0.2126*color[0] + 0.7152*color[1] + 0.0722*color[2]
        if (L > 0.179) {
            return false
        } else {
            return true
        }
    }

    function publish() {
        const articles = db.collection("articles")
        const images = storage.ref()

        const file = document.getElementById("coverImage").files[0]
        const name = `coverImages/${Date.now()}`
        const metadata = {contentType: file.type}

        const author = document.getElementById("author").value
        const headline = document.getElementById("headline").value
        const story = document.getElementById("story").value
        const tag = document.getElementById("tag").value
        
        images.child(name).put(file, metadata)
        .then(snapshot => snapshot.ref.getDownloadURL())
        .then(imageURL => {
            const image = document.getElementById("coverImage")
            image.src = imageURL
            image.crossOrigin = "anonymous";

            let imgEl = document.createElement("img");
            imgEl.src = imageURL;
            imgEl.crossOrigin = "anonymous";
            imgEl.style.display = "none";

            imgEl.onload = function() {
                const color = colorThief.getColor(imgEl, 1)

                articles.add({
                    author: author,
                    headline: headline,
                    coverImage: imageURL,
                    story: story,
                    tag: tag,
                    publishDate: firebase.firestore.Timestamp.now(),
                    likes: 0,
                    color: color,
                    isTextLight: isTextLight(color)
                })

                alert("Published!")
                document.getElementById("publishForm").reset()
            }
        })
    }

    document.getElementById("publishForm").addEventListener("submit", () => {
        // terrible way of authentication only for demo purposes
        if (document.getElementById("psswd").value == "demo") {
            publish()
        }
        else {
            alert("Wrong password!")
        }
    })
</script>

</html>